name: Deploy Python Environment

on:
  push:
    tags:
      - 'env-v*'

jobs:
  build-python-env:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # [중요] setup-python 단계 삭제! (시스템 파이썬 개입 차단)

      - name: Build Pure Isolated Python
        shell: powershell
        run: |
          # 1. 작업 폴더 준비
          $EnvName = "python-env"
          if (Test-Path $EnvName) { Remove-Item $EnvName -Recurse -Force }
          New-Item -ItemType Directory -Path $EnvName -Force
          Write-Host "Building clean environment in: $EnvName"

          # 2. 순정 파이썬 3.11.9 다운로드 (Embeddable)
          # (3.11.13 등 다른 버전이 섞이지 않도록 버전 고정)
          $Url = "https://www.python.org/ftp/python/3.11.9/python-3.11.9-embed-amd64.zip"
          Invoke-WebRequest -Uri $Url -OutFile "python.zip"
          Expand-Archive -Path "python.zip" -DestinationPath $EnvName -Force
          Remove-Item "python.zip" -Force

          # 3. 실행 파일 이름 변경
          $PythonExe = "$EnvName\kiosk_python.exe"
          Rename-Item -Path "$EnvName\python.exe" -NewName "kiosk_python.exe"

          # 4. [핵심] ._pth 파일 수정 (pip 활성화를 위해 필수)
          # 기존 #import site 주석을 제거해야 pip가 작동합니다.
          $PthFile = "$EnvName\python311._pth"
          (Get-Content $PthFile) -replace '#import site', 'import site' | Set-Content $PthFile
          
          # 5. pip 설치 (임베디드 파이썬이 직접 설치하게 함)
          Write-Host "Installing pip..."
          Invoke-WebRequest -Uri "https://bootstrap.pypa.io/get-pip.py" -OutFile "get-pip.py"
          & $PythonExe get-pip.py --no-warn-script-location
          Remove-Item "get-pip.py" -Force

          # 6. 라이브러리 설치 (requirements.txt)
          # 시스템 파이썬이 아닌 '$PythonExe'를 사용하는 것이 포인트입니다.
          Write-Host "Installing requirements..."
          & $PythonExe -m pip install -r requirements.txt --no-warn-script-location --extra-index-url https://download.pytorch.org/whl/cpu

          # 7. PyWin32 DLL 문제 해결 (임베디드 환경 고질병 수정)
          # pywintypes311.dll 등이 시스템 경로가 아닌 옆에 있어야 인식됨
          Write-Host "Fixing PyWin32 DLLs..."
          $PyWin32Dir = "$EnvName\Lib\site-packages\pywin32_system32"
          if (Test-Path $PyWin32Dir) {
              Get-ChildItem -Path $PyWin32Dir -Filter "*.dll" | Copy-Item -Destination $EnvName -Force
          }

          # 8. 불필요 파일 정리 (__pycache__ 등)
          Get-ChildItem -Path $EnvName -Recurse -Filter "__pycache__" | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          Get-ChildItem -Path $EnvName -Recurse -Filter "*.dist-info" | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue

      - name: Zip python-env folder
        run: 7z a python-env.zip python-env

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: python-env.zip
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}