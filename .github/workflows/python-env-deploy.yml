name: Deploy Python Environment

on:
  push:
    tags:
      - 'env-v*' # env-v1.0.0 태그 시 실행

jobs:
  build-python-env:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # [중요 1] 빌드를 담당할 '완전판 파이썬' 세팅 (헤더 파일 포함됨)
      - name: Setup System Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          architecture: 'x64'

      - name: Build Embeddable Python Directory
        shell: powershell
        run: |
          # 1. 이동식 파이썬 다운로드 & 압축 해제
          Write-Host "Downloading Embeddable Python..."
          Invoke-WebRequest -Uri "https://www.python.org/ftp/python/3.11.9/python-3.11.9-embed-amd64.zip" -OutFile "python.zip"
          Expand-Archive -Path "python.zip" -DestinationPath "python-env"
          
          # 2. _pth 파일 수정 (이동식 파이썬이 라이브러리 읽을 수 있게)
          $pth = "python-env/python311._pth"
          (Get-Content $pth) | ForEach-Object { $_ -replace "#import site", "import site" } | Set-Content $pth
          
          # 3. [핵심 변경] '완전판 파이썬'을 사용해 '이동식 폴더'에 라이브러리 강제 주입
          # pip install --target 옵션을 사용합니다.
          Write-Host "Installing libraries using System Python..."
          
          # 빌드 도구 업그레이드 (wheel 에러 방지)
          python -m pip install --upgrade pip setuptools wheel
          
          # 라이브러리 설치 (PyTorch CPU 버전 주소 포함)
          # --no-deps 옵션 없이 설치하여 의존성까지 다 가져오게 함
          # --target python-env : 설치 위치를 여기로 지정!
          python -m pip install -r requirements.txt --target python-env --extra-index-url https://download.pytorch.org/whl/cpu --no-warn-script-location
          
          # 4. 불필요한 파일 정리
          Remove-Item "python.zip"
          # __pycache__ 및 불필요한 dist-info 정리 (용량 절약)
          Get-ChildItem -Path "python-env" -Recurse -Filter "__pycache__" | Remove-Item -Recurse -Force

      # python-env 폴더 압축
      - name: Zip python-env folder
        run: 7z a python-env.zip python-env

      # 릴리즈 업로드
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: python-env.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}