name: Deploy Python Environment

on:
  push:
    tags:
      - 'env-v*' # 예: env-v1.0.2 태그 시 실행

jobs:
  build-python-env:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # [전략] GitHub Runner에 깔린 '완전판 파이썬'을 사용해 빌드 에러 회피
      - name: Setup System Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          architecture: 'x64'

      - name: Build Embeddable Python Directory
        shell: powershell
        run: |
          # 1. 이동식 파이썬(Embeddable) 다운로드 & 압축 해제
          Write-Host "Downloading Embeddable Python..."
          Invoke-WebRequest -Uri "https://www.python.org/ftp/python/3.11.9/python-3.11.9-embed-amd64.zip" -OutFile "python.zip"
          Expand-Archive -Path "python.zip" -DestinationPath "python-env"
          
          # 2. _pth 파일 수정 (라이브러리 인식 활성화)
          $pth = "python-env/python311._pth"
          if (Test-Path $pth) {
              (Get-Content $pth) | ForEach-Object { $_ -replace "#import site", "import site" } | Set-Content $pth
          }
          
          # 3. 라이브러리 설치 (System Python 사용 -> Target은 python-env 폴더)
          Write-Host "Installing libraries using System Python..."
          
          # 3-1. 빌드 도구 업그레이드
          python -m pip install --upgrade pip setuptools wheel
          
          # 3-2. 실제 설치 (PyTorch CPU 버전 지정)
          python -m pip install -r requirements.txt --target python-env/Lib/site-packages --extra-index-url https://download.pytorch.org/whl/cpu --no-warn-script-location
          
          # ----------------------------------------------------------------
          # [수정됨] 4. DLL 구조 작전 (에러 수정)
          # 전체 폴더가 아니라 'Lib/site-packages' 안에 있는 DLL만 꺼내옵니다.
          # -ErrorAction SilentlyContinue: 중복 에러가 나도 무시하고 진행
          # ----------------------------------------------------------------
          Write-Host "Copying DLLs to root..."
          Get-ChildItem -Path "python-env/Lib/site-packages" -Recurse -Filter "*.dll" | Copy-Item -Destination "python-env" -Force -ErrorAction SilentlyContinue
          
          # 5. 용량 최적화
          Remove-Item "python.zip"
          Get-ChildItem -Path "python-env" -Recurse -Filter "__pycache__" | Remove-Item -Recurse -Force

      # python-env 폴더 압축
      - name: Zip python-env folder
        run: 7z a python-env.zip python-env

      # 릴리즈 업로드
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: python-env.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}