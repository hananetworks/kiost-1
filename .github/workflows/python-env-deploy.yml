name: Deploy Python Environment

on:
  push:
    tags:
      - 'env-v*'

jobs:
  build-python-env:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup System Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          architecture: 'x64'

      - name: Build Isolated Python Environment
        shell: powershell
        run: |
          # 1. 격리된 폴더 생성
          $CleanDir = "temp_build"
          New-Item -ItemType Directory -Path $CleanDir -Force
          Write-Host "Building in isolated directory: $CleanDir"

          # 2. 순정 파이썬 다운로드 & 해제
          Invoke-WebRequest -Uri "https://www.python.org/ftp/python/3.11.9/python-3.11.9-embed-amd64.zip" -OutFile "python.zip"
          Expand-Archive -Path "python.zip" -DestinationPath $CleanDir -Force
          
          # 3. 라이브러리 설치 (격리된 폴더로)
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install -r requirements.txt --target "$CleanDir/Lib/site-packages" --extra-index-url https://download.pytorch.org/whl/cpu --no-warn-script-location
          
          # 4. DLL 복사
          if (Test-Path "$CleanDir/Lib/site-packages") {
              Get-ChildItem -Path "$CleanDir/Lib/site-packages" -Recurse -Filter "*.dll" | Copy-Item -Destination $CleanDir -Force -ErrorAction SilentlyContinue
          }

          # 5. ._pth 파일 생성 (핵심! 외부 경로 차단)
          # kiosk_python._pth 라는 이름으로 생성해야 kiosk_python.exe가 읽습니다.
          $pthContent = @(
              "python311.zip",
              ".",
              "Lib/site-packages",
              "import site"
          )
          Set-Content -Path "$CleanDir/kiosk_python._pth" -Value $pthContent
          
          # 기존 python311._pth는 삭제 (혼동 방지)
          if (Test-Path "$CleanDir/python311._pth") { Remove-Item "$CleanDir/python311._pth" -Force }

          # 6. 실행 파일 이름 변경 (kiosk_python.exe)
          Rename-Item -Path "$CleanDir/python.exe" -NewName "kiosk_python.exe"

          # 7. 교체 작전
          if (Test-Path "python-env") { 
              Write-Host "Destroying old python-env..."
              Remove-Item -Path "python-env" -Recurse -Force 
          }
          Rename-Item -Path $CleanDir -NewName "python-env"
          
          # 정리
          Remove-Item "python.zip" -Force
          Get-ChildItem -Path "python-env" -Recurse -Filter "__pycache__" | Remove-Item -Recurse -Force

      - name: Zip python-env folder
        run: 7z a python-env.zip python-env

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: python-env.zip
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}